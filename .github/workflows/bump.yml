name: brew bump
on:
  workflow_dispatch:
  schedule:
    # every day at 6am
    - cron: "0 6 * * *"

permissions:
  contents: write
  pull-requests: write

jobs:
  get-outdated-formulae-and-casks:
    name: Get outdated formulae and casks
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.setmatrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v3
      - name: Set up Homebrew
        id: set-up-homebrew
        uses: Homebrew/actions/setup-homebrew@master
      - name: setup homebrew livecheck_watchlist
        run: |
          mkdir -p ~/.homebrew
          touch ~/.homebrew/livecheck_watchlist.txt
      - name: Get formulae
        run: ls | cut -f 1 -d '.' >> ~/.homebrew/livecheck_watchlist.txt
        working-directory: Formula
      # same as above, but for casks
      - name: Get casks
        run: ls | cut -f 1 -d '.' >> ~/.homebrew/livecheck_watchlist.txt
        working-directory: Casks
      - name: brew livecheck
        run: brew livecheck --json
      # merge the two json arrays into one
      - name: Output matrix
        run: |
          echo matrix="$(brew livecheck --json | jq '[.[] | select(.version.outdated == true) | . + {name: (.cask // .formula)}]')" >> $GITHUB_OUTPUT
        id: setmatrix

  bump-versions:
    needs: get-outdated-formulae-and-casks
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.get-outdated-formulae-and-casks.outputs.matrix) }}
    name: Bump ${{ matrix.name }}
    runs-on: ubuntu-latest
    steps:
      - name: Set up Homebrew
        id: set-up-homebrew
        uses: Homebrew/actions/setup-homebrew@master
      - run: brew tap fdkevin0/tap
      # - name: Set up git
      #   if: steps.livecheck.outputs.outdated == 'true'
      #   run: |
      #     git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
      #     git config --global user.name "github-actions[bot]"
      - name: brew bump-${{ matrix.type }}-pr ${{ matrix.name }}
        run: |
          brew bump-${{ matrix.type }}-pr fdkevin0/tap/${{ matrix.name }} --version=${{ matrix.version.latest }} --no-browse
        env:
          HOMEBREW_GITHUB_API_TOKEN: ${{ github.token }}